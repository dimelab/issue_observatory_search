{% extends "base.html" %}

{% block title %}Network Visualization - Issue Observatory Search{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/custom.css">
<script src="/static/js/network-viz.js"></script>
<style>
    #network-container {
        width: 100%;
        height: calc(100vh - 200px);
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        background: #ffffff;
    }

    .sidebar {
        height: calc(100vh - 200px);
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="networkViewer('{{ network_id }}')" class="space-y-4">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-4">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900" x-text="networkName || 'Network Visualization'"></h1>
                <p class="text-sm text-gray-600 mt-1">
                    <span x-text="stats.nodes"></span> nodes,
                    <span x-text="stats.edges"></span> edges
                </p>
            </div>

            <!-- Toolbar -->
            <div class="flex flex-wrap items-center gap-2">
                <!-- Zoom Controls -->
                <div class="flex border border-gray-300 rounded-md overflow-hidden">
                    <button @click="zoomIn()"
                            class="px-3 py-2 text-gray-700 hover:bg-gray-50 transition-colors"
                            title="Zoom in (+)">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path>
                        </svg>
                    </button>
                    <button @click="fit()"
                            class="px-3 py-2 text-gray-700 hover:bg-gray-50 border-l border-r border-gray-300 transition-colors"
                            title="Fit to view (0)">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                    <button @click="zoomOut()"
                            class="px-3 py-2 text-gray-700 hover:bg-gray-50 transition-colors"
                            title="Zoom out (-)">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
                        </svg>
                    </button>
                </div>

                <!-- Physics Toggle -->
                <button @click="togglePhysics()"
                        :class="{ 'bg-blue-50 text-blue-700 border-blue-300': physics, 'text-gray-700 hover:bg-gray-50': !physics }"
                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium transition-colors"
                        title="Toggle physics (P)">
                    <span x-show="physics">Physics: On</span>
                    <span x-show="!physics">Physics: Off</span>
                </button>

                <!-- Export -->
                <button @click="exportPNG()"
                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
                        title="Export as PNG">
                    <svg class="inline-block h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Export
                </button>

                <!-- Settings -->
                <button @click="showSettings = !showSettings"
                        class="px-3 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Stabilization Progress -->
        <div x-show="stabilizing" x-cloak class="mt-4">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-gray-700">Stabilizing network...</span>
                <span class="text-sm font-medium text-gray-700" x-text="stabilizationProgress + '%'"></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                     :style="'width: ' + stabilizationProgress + '%'"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-4">
            <!-- Search -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Search Nodes</h3>
                <input type="text"
                       x-model="searchQuery"
                       @input.debounce.300ms="search()"
                       placeholder="Search by label..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Filter by Type</h3>
                <div class="space-y-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox"
                               value="search"
                               x-model="filterTypes"
                               @change="applyFilters()"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">
                            <span class="inline-block w-3 h-3 rounded-full bg-blue-500"></span>
                            Searches
                        </span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox"
                               value="website"
                               x-model="filterTypes"
                               @change="applyFilters()"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">
                            <span class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
                            Websites
                        </span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox"
                               value="noun"
                               x-model="filterTypes"
                               @change="applyFilters()"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">
                            <span class="inline-block w-3 h-3 rounded-full bg-amber-500"></span>
                            Nouns
                        </span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox"
                               value="entity"
                               x-model="filterTypes"
                               @change="applyFilters()"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">
                            <span class="inline-block w-3 h-3 rounded-full bg-purple-500"></span>
                            Entities
                        </span>
                    </label>
                </div>
                <button @click="clearFilters()"
                        class="mt-3 w-full px-3 py-2 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">
                    Clear Filters
                </button>
            </div>

            <!-- Statistics -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Network Statistics</h3>
                <dl class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <dt class="text-gray-600">Nodes:</dt>
                        <dd class="font-medium text-gray-900" x-text="stats.nodes"></dd>
                    </div>
                    <div class="flex justify-between text-sm">
                        <dt class="text-gray-600">Edges:</dt>
                        <dd class="font-medium text-gray-900" x-text="stats.edges"></dd>
                    </div>
                    <div class="flex justify-between text-sm">
                        <dt class="text-gray-600">Density:</dt>
                        <dd class="font-medium text-gray-900" x-text="stats.density?.toFixed(4) || '0'"></dd>
                    </div>
                    <div class="flex justify-between text-sm">
                        <dt class="text-gray-600">Avg. Degree:</dt>
                        <dd class="font-medium text-gray-900" x-text="stats.avgDegree?.toFixed(2) || '0'"></dd>
                    </div>
                </dl>
            </div>

            <!-- Selected Node Details -->
            <div x-show="selectedNode" x-cloak class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Selected Node</h3>
                <div class="space-y-2">
                    <div>
                        <p class="text-xs text-gray-600">Label</p>
                        <p class="text-sm font-medium text-gray-900" x-text="selectedNode?.label"></p>
                    </div>
                    <div x-show="selectedNode?.type">
                        <p class="text-xs text-gray-600">Type</p>
                        <p class="text-sm font-medium text-gray-900" x-text="selectedNode?.type"></p>
                    </div>
                    <div x-show="selectedNode?.weight">
                        <p class="text-xs text-gray-600">Weight</p>
                        <p class="text-sm font-medium text-gray-900" x-text="selectedNode?.weight"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Canvas -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-lg shadow-md p-4">
                <div id="network-container"></div>
            </div>
        </div>
    </div>
</div>

<script>
    function networkViewer(networkId) {
        return {
            networkId: networkId,
            networkName: '',
            visualizer: null,
            physics: true,
            searchQuery: '',
            filterTypes: [],
            selectedNode: null,
            stabilizing: false,
            stabilizationProgress: 0,
            showSettings: false,
            stats: {
                nodes: 0,
                edges: 0,
                density: 0,
                avgDegree: 0
            },

            init() {
                // Initialize network visualizer
                this.visualizer = new NetworkVisualizer('network-container', {
                    physics: true
                });

                // Override callbacks
                this.visualizer.onNodeSelect = (node) => {
                    this.selectedNode = node;
                };

                this.visualizer.onNodeDeselect = () => {
                    this.selectedNode = null;
                };

                this.visualizer.onStabilizationProgress = (progress) => {
                    this.stabilizing = true;
                    this.stabilizationProgress = progress;
                };

                this.visualizer.onStabilizationComplete = () => {
                    this.stabilizing = false;
                    this.updateStats();
                };

                // Load network data
                this.loadNetwork();

                // Setup keyboard shortcuts
                this.setupKeyboardShortcuts();
            },

            async loadNetwork() {
                const url = `/api/networks/${this.networkId}/gexf`;
                await this.visualizer.loadFromGEXF(url);
                this.updateStats();
            },

            updateStats() {
                this.stats = this.visualizer.getStatistics();
            },

            search() {
                this.visualizer.searchNodes(this.searchQuery);
                this.updateStats();
            },

            applyFilters() {
                this.visualizer.filterByType(this.filterTypes);
                this.updateStats();
            },

            clearFilters() {
                this.searchQuery = '';
                this.filterTypes = [];
                this.visualizer.clearFilters();
                this.updateStats();
            },

            togglePhysics() {
                this.physics = this.visualizer.togglePhysics();
            },

            zoomIn() {
                this.visualizer.zoomIn();
            },

            zoomOut() {
                this.visualizer.zoomOut();
            },

            fit() {
                this.visualizer.fit();
            },

            exportPNG() {
                const filename = `network-${this.networkId}.png`;
                this.visualizer.exportAsPNG(filename);
            },

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Ignore if typing in input
                    if (e.target.tagName === 'INPUT') return;

                    switch(e.key) {
                        case '+':
                        case '=':
                            this.zoomIn();
                            break;
                        case '-':
                            this.zoomOut();
                            break;
                        case '0':
                            this.fit();
                            break;
                        case 'p':
                        case 'P':
                            this.togglePhysics();
                            break;
                    }
                });
            }
        };
    }
</script>
{% endblock %}
