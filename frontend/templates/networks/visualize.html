{% extends "base.html" %}

{% block title %}Network Visualization - Issue Observatory Search{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="/static/css/custom.css">
<!-- v6.0.0: Graphology visualizer (default), Vis.js kept for backward compatibility -->
<script src="/static/js/network-viz-graphology.js"></script>
<script src="/static/js/network-viz.js"></script>
<style>
    #network-container {
        width: 100%;
        height: calc(100vh - 200px);
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        background: #ffffff;
    }

    .sidebar {
        height: calc(100vh - 200px);
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="networkViewer('{{ network_id }}')" class="space-y-4">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-4">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900" x-text="networkName || 'Network Visualization'"></h1>
                <p class="text-sm text-gray-600 mt-1">
                    <span x-text="stats.nodes"></span> nodes,
                    <span x-text="stats.edges"></span> edges
                </p>
            </div>

            <!-- Toolbar -->
            <div class="flex flex-wrap items-center gap-2">
                <!-- Zoom Controls -->
                <div class="flex border border-gray-300 rounded-md overflow-hidden">
                    <button @click="zoomIn()"
                            class="px-3 py-2 text-gray-700 hover:bg-gray-50 transition-colors"
                            title="Zoom in (+)">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6m3-3H7"></path>
                        </svg>
                    </button>
                    <button @click="fit()"
                            class="px-3 py-2 text-gray-700 hover:bg-gray-50 border-l border-r border-gray-300 transition-colors"
                            title="Fit to view (0)">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                    <button @click="zoomOut()"
                            class="px-3 py-2 text-gray-700 hover:bg-gray-50 transition-colors"
                            title="Zoom out (-)">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path>
                        </svg>
                    </button>
                </div>

                <!-- Layout Controls -->
                <button @click="startLayout()"
                        :disabled="layoutRunning"
                        :class="layoutRunning ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-50'"
                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 transition-colors">
                    ▶️ Start Layout
                </button>

                <button @click="stopLayout()"
                        :disabled="!layoutRunning"
                        :class="!layoutRunning ? 'opacity-50 cursor-not-allowed' : 'hover:bg-red-50'"
                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 transition-colors">
                    ⏸️ Stop Layout
                </button>

                <!-- Export -->
                <button @click="exportPNG()"
                        class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
                        title="Export as PNG">
                    <svg class="inline-block h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Export
                </button>

                <!-- Layout Settings Toggle -->
                <button @click="showLayoutSettings = !showLayoutSettings"
                        :class="showLayoutSettings ? 'bg-blue-50 text-blue-700 border-blue-300' : 'text-gray-700 hover:bg-gray-50'"
                        class="px-3 py-2 border border-gray-300 rounded-md transition-colors">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Layout Settings Panel -->
        <div x-show="showLayoutSettings" x-cloak class="mt-4 bg-white rounded-lg shadow-md p-4">
            <h3 class="text-sm font-semibold text-gray-900 mb-4">ForceAtlas2 Settings</h3>

            <div class="space-y-4">
                <!-- Gravity -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-sm font-medium text-gray-700">Gravity</label>
                        <span class="text-sm text-gray-600" x-text="layoutSettings.gravity"></span>
                    </div>
                    <input type="range"
                           x-model.number="layoutSettings.gravity"
                           @input="updateLayoutSettings()"
                           min="0" max="5" step="0.1"
                           class="w-full">
                </div>

                <!-- Scaling Ratio -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-sm font-medium text-gray-700">Scaling</label>
                        <span class="text-sm text-gray-600" x-text="layoutSettings.scalingRatio"></span>
                    </div>
                    <input type="range"
                           x-model.number="layoutSettings.scalingRatio"
                           @input="updateLayoutSettings()"
                           min="1" max="50" step="1"
                           class="w-full">
                </div>

                <!-- Edge Weight Influence -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-sm font-medium text-gray-700">Edge Weight</label>
                        <span class="text-sm text-gray-600" x-text="layoutSettings.edgeWeightInfluence"></span>
                    </div>
                    <input type="range"
                           x-model.number="layoutSettings.edgeWeightInfluence"
                           @input="updateLayoutSettings()"
                           min="0" max="2" step="0.1"
                           class="w-full">
                </div>

                <!-- Barnes-Hut Optimization -->
                <div class="flex items-center">
                    <input type="checkbox"
                           x-model="layoutSettings.barnesHutOptimize"
                           @change="updateLayoutSettings()"
                           id="barnesHut"
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="barnesHut" class="ml-2 text-sm text-gray-700">Barnes-Hut Optimization</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-4">
            <!-- Search -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Search Nodes</h3>
                <input type="text"
                       x-model="searchQuery"
                       @input.debounce.300ms="search()"
                       placeholder="Search by label..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Filter by Type</h3>
                <div class="space-y-2">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox"
                               value="search"
                               x-model="filterTypes"
                               @change="applyFilters()"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">
                            <span class="inline-block w-3 h-3 rounded-full bg-blue-500"></span>
                            Searches
                        </span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox"
                               value="website"
                               x-model="filterTypes"
                               @change="applyFilters()"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">
                            <span class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
                            Websites
                        </span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox"
                               value="noun"
                               x-model="filterTypes"
                               @change="applyFilters()"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">
                            <span class="inline-block w-3 h-3 rounded-full bg-amber-500"></span>
                            Nouns
                        </span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox"
                               value="entity"
                               x-model="filterTypes"
                               @change="applyFilters()"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">
                            <span class="inline-block w-3 h-3 rounded-full bg-purple-500"></span>
                            Entities
                        </span>
                    </label>
                </div>
                <button @click="clearFilters()"
                        class="mt-3 w-full px-3 py-2 text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors">
                    Clear Filters
                </button>
            </div>

            <!-- Statistics -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Network Statistics</h3>
                <dl class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <dt class="text-gray-600">Nodes:</dt>
                        <dd class="font-medium text-gray-900" x-text="stats.nodes"></dd>
                    </div>
                    <div class="flex justify-between text-sm">
                        <dt class="text-gray-600">Edges:</dt>
                        <dd class="font-medium text-gray-900" x-text="stats.edges"></dd>
                    </div>
                    <div class="flex justify-between text-sm">
                        <dt class="text-gray-600">Density:</dt>
                        <dd class="font-medium text-gray-900" x-text="stats.density?.toFixed(4) || '0'"></dd>
                    </div>
                    <div class="flex justify-between text-sm">
                        <dt class="text-gray-600">Avg. Degree:</dt>
                        <dd class="font-medium text-gray-900" x-text="stats.avgDegree?.toFixed(2) || '0'"></dd>
                    </div>
                </dl>
            </div>

            <!-- Selected Node Details -->
            <div x-show="selectedNode" x-cloak class="bg-white rounded-lg shadow-md p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Selected Node</h3>
                <div class="space-y-2">
                    <div>
                        <p class="text-xs text-gray-600">Label</p>
                        <p class="text-sm font-medium text-gray-900" x-text="selectedNode?.label"></p>
                    </div>
                    <div x-show="selectedNode?.type">
                        <p class="text-xs text-gray-600">Type</p>
                        <p class="text-sm font-medium text-gray-900" x-text="selectedNode?.type"></p>
                    </div>
                    <div x-show="selectedNode?.weight">
                        <p class="text-xs text-gray-600">Weight</p>
                        <p class="text-sm font-medium text-gray-900" x-text="selectedNode?.weight"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Canvas -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-lg shadow-md p-4">
                <div id="network-container"></div>
            </div>
        </div>
    </div>
</div>

<script>
    function networkViewer(networkId) {
        return {
            networkId: networkId,
            networkName: '',
            visualizer: null,
            searchQuery: '',
            filterTypes: [],
            selectedNode: null,
            showLayoutSettings: false,
            layoutRunning: false,
            layoutSettings: {
                gravity: 1.0,
                scalingRatio: 10,
                edgeWeightInfluence: 1.0,
                barnesHutOptimize: true,
                barnesHutTheta: 1.2,
                slowDown: 1
            },
            stats: {
                nodes: 0,
                edges: 0,
                density: 0,
                avgDegree: 0
            },

            init() {
                // v6.0.0: Use Graphology visualizer with custom FA2 settings
                console.log('Using Graphology + Sigma.js visualizer (v6.0.0)');
                this.visualizer = new GraphologyNetworkVisualizer('network-container', {
                    fa2Settings: this.layoutSettings
                });

                // Override callbacks
                this.visualizer.onNodeSelect = (node) => {
                    this.selectedNode = node;
                };

                this.visualizer.onNodeDeselect = () => {
                    this.selectedNode = null;
                };

                // Load network data
                this.loadNetwork();

                // Setup keyboard shortcuts
                this.setupKeyboardShortcuts();
            },

            async loadNetwork() {
                try {
                    const url = `/api/networks/${this.networkId}/download`;
                    await this.visualizer.loadFromGEXF(url);
                    this.updateStats();
                } catch (error) {
                    console.error('Failed to load network:', error);
                    showToast('Failed to load network', 'error');
                }
            },

            updateStats() {
                this.stats = this.visualizer.getStatistics();
            },

            search() {
                this.visualizer.searchNodes(this.searchQuery);
                this.updateStats();
            },

            applyFilters() {
                this.visualizer.filterByType(this.filterTypes);
                this.updateStats();
            },

            clearFilters() {
                this.searchQuery = '';
                this.filterTypes = [];
                this.visualizer.clearFilters();
                this.updateStats();
            },

            // Layout control methods
            startLayout() {
                if (this.visualizer && typeof this.visualizer.startLayout === 'function') {
                    this.visualizer.startLayout();
                    this.layoutRunning = true;
                }
            },

            stopLayout() {
                if (this.visualizer && typeof this.visualizer.stopLayout === 'function') {
                    this.visualizer.stopLayout();
                    this.layoutRunning = false;
                }
            },

            updateLayoutSettings() {
                // Update settings and restart layout if running
                if (this.visualizer && typeof this.visualizer.updateLayoutSettings === 'function') {
                    this.visualizer.updateLayoutSettings(this.layoutSettings);
                    // If layout was running, restart it
                    if (this.layoutRunning) {
                        this.visualizer.startLayout();
                    }
                }
            },

            zoomIn() {
                this.visualizer.zoomIn();
            },

            zoomOut() {
                this.visualizer.zoomOut();
            },

            fit() {
                this.visualizer.fit();
            },

            exportPNG() {
                const filename = `network-${this.networkId}.png`;
                this.visualizer.exportAsPNG(filename);
            },

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Ignore if typing in input
                    if (e.target.tagName === 'INPUT') return;

                    switch(e.key) {
                        case '+':
                        case '=':
                            this.zoomIn();
                            break;
                        case '-':
                            this.zoomOut();
                            break;
                        case '0':
                            this.fit();
                            break;
                    }
                });
            }
        };
    }
</script>
{% endblock %}
